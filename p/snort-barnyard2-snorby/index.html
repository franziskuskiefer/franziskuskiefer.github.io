<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='This post is work in progress but I never got around to finishing it. Sorry
After a first failed attempt to install Snorby on an Arch Linux server (Snorby requires Ruby 1.9.x, Arch uses 2.x and I&amp;rsquo;m not willing to use the AUR version for this) I&amp;rsquo;m doing this on a Ubuntu 14.04 Server.
Snort Before installing Snorby we have to install snort itself. This can be done with sudo apt-get install snort.'><title>Snort, Barnyard2 &amp; Snorby</title>

<link rel='canonical' href='https://www.franziskuskiefer.de/p/snort-barnyard2-snorby/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Snort, Barnyard2 &amp; Snorby'>
<meta property='og:description' content='This post is work in progress but I never got around to finishing it. Sorry
After a first failed attempt to install Snorby on an Arch Linux server (Snorby requires Ruby 1.9.x, Arch uses 2.x and I&amp;rsquo;m not willing to use the AUR version for this) I&amp;rsquo;m doing this on a Ubuntu 14.04 Server.
Snort Before installing Snorby we have to install snort itself. This can be done with sudo apt-get install snort.'>
<meta property='og:url' content='https://www.franziskuskiefer.de/p/snort-barnyard2-snorby/'>
<meta property='og:site_name' content='Dr Franziskus Kiefer'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='ids' /><meta property='article:tag' content='snort' /><meta property='article:tag' content='barnyard2' /><meta property='article:published_time' content='2014-10-05T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2014-10-05T00:00:00&#43;00:00'/><meta property='og:image' content='https://www.franziskuskiefer.de/images/profilepic.jpg' />
<meta name="twitter:site" content="@_franziskus_">
    <meta name="twitter:creator" content="@_franziskus_"><meta name="twitter:title" content="Snort, Barnyard2 &amp; Snorby">
<meta name="twitter:description" content="This post is work in progress but I never got around to finishing it. Sorry
After a first failed attempt to install Snorby on an Arch Linux server (Snorby requires Ruby 1.9.x, Arch uses 2.x and I&amp;rsquo;m not willing to use the AUR version for this) I&amp;rsquo;m doing this on a Ubuntu 14.04 Server.
Snort Before installing Snorby we have to install snort itself. This can be done with sudo apt-get install snort."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.franziskuskiefer.de/images/profilepic.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://www.franziskuskiefer.de/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/p/snort-barnyard2-snorby/">Snort, Barnyard2 &amp; Snorby</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 05, 2014</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    5 min read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p><strong>This post is work in progress but I never got around to finishing it. Sorry</strong></p>
<p>After a first failed attempt to install Snorby on an Arch Linux server (Snorby requires Ruby 1.9.x, Arch uses 2.x and I&rsquo;m not willing to use the AUR version for this) I&rsquo;m doing this on a Ubuntu 14.04 Server.</p>
<h1 id="snort">Snort</h1>
<p>Before installing Snorby we have to install snort itself. This can be done with <code>sudo apt-get install snort</code>. Snort asks for a network address range to use for <code>HOME_NET</code>. Since I&rsquo;m not sure what to use here (the network may change), I just use standard value. This can later be changed using snort config files.</p>
<p>For testing purposes I add a new rule file in <code>/etc/snort/rules/</code> with a very basic rule that logs everything. <em>You really shouldn&rsquo;t do this in productive use, this will spam your snort output.</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">file: test.rules
alert ip any any -&gt; any any <span class="o">(</span>msg:<span class="s2">&#34;Someone tried to access the server&#34;</span><span class="p">;</span> sid:100001<span class="p">;</span> rev:1<span class="p">;</span> priority:2<span class="p">;</span><span class="o">)</span>
</code></pre></div><p>To use the new rule file you have to include it in the snort config <code>/etc/snort/snort.conf</code> by adding a line <code>include $RULE_PATH/test.rules</code>.</p>
<h2 id="configuration">Configuration</h2>
<p>In order to inspect outgoing traffic I had to add the <code>-k none</code> option to Snort in order to disable checksum tests for TCP connections (cf. <a class="link" href="https://serverfault.com/questions/554713/snort-not-detecting-outgoing-traffic"  target="_blank" rel="noopener"
    >serverfault</a>). The option can be permanently added by adding it to <code>PARAMS</code> in <code>/etc/default/snort</code>.</p>
<h2 id="rules">Rules</h2>
<p>A common requirement for rules on a server is to inspect outgoing documents for suspicious content. Checking for example if a website contains a certain string can be done as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">alert tcp any <span class="m">80</span> -&gt; any any <span class="o">(</span>file_data<span class="p">;</span> content:<span class="s2">&#34;Placeholder&#34;</span><span class="p">;</span> flow:to_client,established<span class="p">;</span> msg:<span class="s2">&#34;Detected placeholderwebsite&#34;</span><span class="p">;</span> sid:1000002<span class="p">;</span> rev:1<span class="p">;</span> priority:2<span class="p">;</span><span class="o">)</span>
</code></pre></div><p>In order for this rule to work properly one has to make sure that <code>snort.conf</code> contains at least the following elements for <code>http_inspect_server</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">xtended_response_inspection <span class="se">\
</span><span class="se"></span>inspect_gzip <span class="se">\
</span><span class="se"></span>normalize_utf <span class="se">\
</span><span class="se"></span>server_flow_depth <span class="m">0</span> <span class="se">\
</span><span class="se"></span>normalize_javascript
</code></pre></div><h2 id="snorby">Snorby</h2>
<p>Before installing snorby I need to make sure that certain software is installed.</p>
<h3 id="prerequesite">Prerequesite</h3>
<p>The base system is a fresh Ubuntu 14.04 Server installation. Before installing Snorby we have to make sure that all requirements are installed. The <a class="link" href="http://snorby.org"  target="_blank" rel="noopener"
    >Snorby website</a> lists the following dependencies: <code>git</code>, <code>ruby</code>, <code>ImageMagick</code> and <code>Wkhtmltopdf</code>. But installing dependencies is not as easy as it sounds. I&rsquo;m on a headless server and don&rsquo;t want to install video drivers. So what to do with the strange <code>Wkhtmltopdf</code> package? And why the heck does a headless application need X? But luckily there is a ruby gem of wkhtmltopdf that does not need any X component (documentation of Snorby is really bad here). So we just use <code>sudo gem install wkhtmltopdf</code> and we are good (ignore the errors during installation). We also have to install <code>ruby-dev</code> and <code>make</code> on Ubuntu. Further we need <code>mysql-server</code> installed. To get rails and bundler we have to install them with <code>sudo gem install bundler</code> and <code>sudo gem install rails</code>.</p>
<h3 id="installing-snorby">Installing Snorby</h3>
<p>Now we need to get snorby sources</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/Snorby/snorby
</code></pre></div><p>After changing to the <code>cd snorby</code> directory we can install it using <code>bundle install</code>.</p>
<p>Now we have to configure snorby to be able to read events from the database. To do so we copy <code>database.yml.example</code> in the <code>config</code> folder to <code>database.yml</code> and change the database configuration to access MySQL. Further we copy <code>snorby_config.yml.example</code> to <code>snorby_config.yml</code> and check that <code>wkhtmltopdf</code> and <code>domain</code> are correct in the <code>production</code> section. It seems there are more dependencies needed (in particular <code>nokogiri</code> needs more). So we have to install <code>libxml2-dev</code>, <code>libxslt-dev</code>, <code> libmysqlclient-dev</code>, <code>g++</code>.</p>
<p>Now we should be able to run</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">bundle <span class="nb">exec</span> rake snorby:setup
</code></pre></div><p>to set-up snorby and start it with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">bundle <span class="nb">exec</span> rails server -e production
</code></pre></div><h2 id="instaling-barnyard2">Instaling Barnyard2</h2>
<p>To get the snort output into our Snorby interface we use <a class="link" href="https://github.com/firnsy/barnyard2"  target="_blank" rel="noopener"
    >Barnyard2</a>. Since there is no package for Ubuntu in the official repositories we have to build Barnyard2 from source.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/firnsy/barnyard2
</code></pre></div><p>To build Barnyard2 we need some developement tools</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get install build-essential libtool autoconf libpcap-dev libmysqld-dev
</code></pre></div><p>After changing to the Barnyard2 directory <code>cd barnyard2</code> we run <code>./autogen.sh</code>, configure it for MySQL <code>./configure --with-mysql --with-mysql-libraries=/usr/lib/x86_64-linux-gnu/</code> (the additional library and include path are necessary on Ubuntu to find MySQL) run <code>make</code>. I only enable MySQL here, but other outpus are possible. To eventually install Barnyard to we use <code>sudo make install</code>.</p>
<p>After installing Barnyard2 it needs configuration. First I copy the example config file <code>sudo cp etc/barnyard2.conf /etc/</code> before modifying it to run as a daemon and write to the database</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">config daemon
config hostname: localhost
config interface: eth0
output database: log, mysql, <span class="nv">user</span><span class="o">=</span>root <span class="nv">password</span><span class="o">=</span>root <span class="nv">dbname</span><span class="o">=</span>snort <span class="nv">host</span><span class="o">=</span>localhost
config logdir: /var/log/barnyard2/
config waldo_file: /var/log/barnyard2/barnyard2.waldo
</code></pre></div><h3 id="database-setup">Database Setup</h3>
<p>We have to set up the Barnyard2 database. We create a new database <code>create database snort;</code>, get the Barnyard2 schema</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">wget https://raw.github.com/firnsy/barnyard2/master/schemas/create_mysql
</code></pre></div><p>and install it to our new database <code>mysql -u &lt;user&gt; -p snort &lt; create_mysql</code>.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>I ran into the problem that snort had no <code>sid-msg.map</code>. This can be created with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /usr/share/oinkmaster/create-sidmap.pl rules/ &gt; sid-msg.map</span>
</code></pre></div><p>in <code>/etc/snort</code>. I ran into some further problems and had to create the waldo file manually, i.e.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo touch /var/log/barnyard2/barnyard2.waldo
sudo chown snort:snort /var/log/barnyard2/barnyard2.waldo
</code></pre></div><p>This still throws a warning that the waldo file is corrupt, but Barnyard2 is at least running. I got a lot of warnings of the form</p>
<pre><code>WARNING: Can't extract timestamp extension from '..'using base ''
from old/corrupted snort log files. So I removed all logs from `/var/log/snort/`. Note that this warning is also shown when the snort log is empty!
</code></pre>
<p>To start Barnyard2 now we use</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo /usr/local/bin/barnyard2 -c /etc/barnyard2.conf -d /var/log/snort/ -f snort.out
</code></pre></div><p>where the first parameter sets the config file to use, the second tells barynard2 in which folder to look for snort output files and the last one gives the base-name of snort output in that folder.</p>
<h1 id="testing-the-setup">Testing the setup</h1>
<p>To test if Snorby is actually working I install and start Apache. This is not necessary since my snort rule from above is logging everything, but you may want to do this anyway to test some real rules. The Snorby web interface is located at <code>http://&lt;server ip&gt;:3000/</code>. The default credentials are <code>Username: snorby@snorby.org, Password: snorby</code>.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ids/">ids</a>
        
            <a href="/tags/snort/">snort</a>
        
            <a href="/tags/barnyard2/">barnyard2</a>
        
    </section>


    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
     
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2013 - 
        
        2021 Dr Franziskus Kiefer
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.1.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#configuration">Configuration</a></li>
    <li><a href="#rules">Rules</a></li>
    <li><a href="#snorby">Snorby</a>
      <ol>
        <li><a href="#prerequesite">Prerequesite</a></li>
        <li><a href="#installing-snorby">Installing Snorby</a></li>
      </ol>
    </li>
    <li><a href="#instaling-barnyard2">Instaling Barnyard2</a>
      <ol>
        <li><a href="#database-setup">Database Setup</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ol>
    </li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
