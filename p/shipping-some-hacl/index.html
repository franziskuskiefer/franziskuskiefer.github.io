<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='If you didn&amp;rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr
 HACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.
  In this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms.'><title>Shipping (some) HACL*</title>

<link rel='canonical' href='https://www.franziskuskiefer.de/p/shipping-some-hacl/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Shipping (some) HACL*'>
<meta property='og:description' content='If you didn&amp;rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr
 HACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.
  In this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms.'>
<meta property='og:url' content='https://www.franziskuskiefer.de/p/shipping-some-hacl/'>
<meta property='og:site_name' content='Dr Franziskus Kiefer'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='nss' /><meta property='article:tag' content='HACL*' /><meta property='article:tag' content='formal verification' /><meta property='article:published_time' content='2018-04-12T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2018-04-12T00:00:00&#43;00:00'/><meta property='og:image' content='https://www.franziskuskiefer.de/p/shipping-some-hacl/hero.jpg' />
<meta name="twitter:site" content="@_franziskus_">
    <meta name="twitter:creator" content="@_franziskus_"><meta name="twitter:title" content="Shipping (some) HACL*">
<meta name="twitter:description" content="If you didn&amp;rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr
 HACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.
  In this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.franziskuskiefer.de/p/shipping-some-hacl/hero.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://www.franziskuskiefer.de/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/shipping-some-hacl/">
                <img src="/p/shipping-some-hacl/hero_hu3d03a01dcc18bc5be0e67db3d8d209a6_420155_800x0_resize_q75_box.jpg"
                        srcset="/p/shipping-some-hacl/hero_hu3d03a01dcc18bc5be0e67db3d8d209a6_420155_800x0_resize_q75_box.jpg 800w, /p/shipping-some-hacl/hero_hu3d03a01dcc18bc5be0e67db3d8d209a6_420155_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="533" 
                        loading="lazy"
                        alt="Featured image of post Shipping (some) HACL*" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/p/shipping-some-hacl/">Shipping (some) HACL*</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 12, 2018</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    6 min read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>If you didn&rsquo;t read the article about the <a class="link" href="../hacl-star/" >HACL* approach</a>, go there first and read it. tl;dr</p>
<blockquote>
<p><a class="link" href="https://github.com/mitls/hacl-star/"  target="_blank" rel="noopener"
    >HACL*</a> is a cryptographic library written in <a class="link" href="https://www.fstar-lang.org/"  target="_blank" rel="noopener"
    >F*</a> that allows translation to C using kremlin.
It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.</p>
</blockquote>
<hr>
<p>In this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms.
In short, how to ship (some parts of) HACL*.</p>
<h1 id="shipping-formally-verified-code">Shipping formally verified code</h1>
<p>Before integrating any code from HACL* into NSS there had to be some criteria the code had to fulfil in order to get considered and a process of integrating, maintaining, and updating the code.
The criteria roughly looked like this:</p>
<ul>
<li>The code has to be correct.</li>
<li>Performance must not be degraded by any new code.</li>
<li>The code has to be human readable and modifiable, i.e. it must pass a code review process.</li>
<li>The code must run on all platforms supported by NSS or must have fallback code for platforms that are not supported.</li>
<li>Upstream changes can to be integrated easily into NSS and fixes can be integrated upstream.</li>
<li>The verification and generation toolchain has to run in the NSS world.</li>
</ul>
<p>We started integrating HACL* crypto primitives into NSS with <a class="link" href="https://tools.ietf.org/html/rfc7748"  target="_blank" rel="noopener"
    >Curve25519</a>.
At the time of writing NSS contains code from HACL* for Curve25519 64-bit, <a class="link" href="https://tools.ietf.org/html/rfc7539"  target="_blank" rel="noopener"
    >Poly1305</a> 32-bit and 64-bit, <a class="link" href="https://tools.ietf.org/html/rfc7539"  target="_blank" rel="noopener"
    >ChaCha20</a>, and ChaCha20 with SSSE3 hardware acceleration.
More primitives are in the pipeline and will be integrated in the near future.</p>
<h2 id="correctness">Correctness</h2>
<p>Any code that lands in NSS has to be correct, obviously.
This might be evident but when talking about HACL* generated C code, correctness is not so simple.
Correctness can be checked relatively easily by looking at the HACL* specification of a given primitive.
This code is relatively easy to review (when familiar with F*) as it closely resembles the mathematical specification of the primitive.
The correctness of the C code is guaranteed by the formal proofs from HACL*.
In addition we run all the usual test vectors on it of course.
To catch any errors in the extraction chain from F* to C the extracted C code is reviewed for correctness as well.</p>
<h2 id="performance">Performance</h2>
<p>Performance was not a big concern.
As shown in the <a class="link" href="https://github.com/mitls/hacl-star/blob/master/doc/papers/hacl-star-ccs2017.pdf"  target="_blank" rel="noopener"
    >HACL* paper from CCS 2017</a>, performance of most primitives is on par with or better than the fastest C implementations out there.
Nonetheless, performance of each primitive is compared between HACL* and the NSS to make sure not to degrade performance.
For every primitive I looked at so far the performance of HACL* was at least as good as the performance of the NSS code.</p>
<h2 id="code-quality">Code quality</h2>
<p>Code quality was, as with any generated code, a big concern.
How readable is the generated code? Can it easily be changed if the need arises?
The first versions we looked at weren&rsquo;t that great &hellip;</p>
<p><figure style="flex-grow: 265; flex-basis: 637px">
		<a href="/p/shipping-some-hacl/hacl-review.png" data-size="1983x747"><img src="/p/shipping-some-hacl/hacl-review.png"
				srcset="/p/shipping-some-hacl/hacl-review_hucd9959a0171e896eec7c417310d2ea11_228638_480x0_resize_box_3.png 480w, /p/shipping-some-hacl/hacl-review_hucd9959a0171e896eec7c417310d2ea11_228638_1024x0_resize_box_3.png 1024w"
				width="1983"
				height="747"
				loading="lazy"
				>
		</a>
		
	</figure>
<figure style="flex-grow: 513; flex-basis: 1232px">
		<a href="/p/shipping-some-hacl/ugly-hacl.png" data-size="755x147"><img src="/p/shipping-some-hacl/ugly-hacl.png"
				srcset="/p/shipping-some-hacl/ugly-hacl_hua247d0e64cbda0435f58ad9ca08350bd_23578_480x0_resize_box_3.png 480w, /p/shipping-some-hacl/ugly-hacl_hua247d0e64cbda0435f58ad9ca08350bd_23578_1024x0_resize_box_3.png 1024w"
				width="755"
				height="147"
				loading="lazy"
				>
		</a>
		
	</figure></p>
<p>But after a couple improvements to kremlin the code was good to go.
While every new piece of code that&rsquo;s being integrated has to pass code review the C code produced by kremlin is good enough now to land new primitives without having to improve upstream code first.
Note however that code passes review here that wouldn&rsquo;t pass if it were hand-written.
The code generator is not perfect.
We have to live with some rough edges.
The most important point is that the code is understandable.</p>
<p>NSS if formatted with <code>clang-format</code>, which is checked on CI.
So the only change to the verified C code imported from HACL* is formatting.</p>
<h3 id="some-pain-points-remain">Some pain points remain</h3>
<p>There are some outstanding issues that I hope get fixed in kremlin and would improve code quality significantly.
Kremlin doesn&rsquo;t know <code>const</code>, which is one of the few nice helpers one can use in C to control what&rsquo;s happening to your pointer.
While <code>const</code> is not necessary because of the HACL* proofs, it would be nice to have.
Kremlin further generates unnecessary casts such as <code>(uint32_t)4U</code>.
This is not a big deal but makes code harder to read.
There&rsquo;s also a big number of temporary variables that aren&rsquo;t necessary and make the code harder to read.</p>
<h2 id="platform-support">Platform support</h2>
<p>Being a researchy library HACL* is not tested on a big variety of platforms.
NSS on the other hand has to run on most available platforms as well as a number of legacy platforms.
While the NSS CI covers Windows, Linux, and Mac in different configurations such as Intel 32-bit, 64-bit, and aarch64, there are other platforms such as BSD using NSS that are not covered.
As expected we ran into a couple issues on some platforms such as BSD and Solaris but they were quickly resolved.</p>
<p><figure style="flex-grow: 1113; flex-basis: 2671px">
		<a href="/p/shipping-some-hacl/nss-bsd-hacl-bug.png" data-size="2048x184"><img src="/p/shipping-some-hacl/nss-bsd-hacl-bug.png"
				srcset="/p/shipping-some-hacl/nss-bsd-hacl-bug_hu8f546d68494cda5357b945ab8d6d4090_37035_480x0_resize_box_3.png 480w, /p/shipping-some-hacl/nss-bsd-hacl-bug_hu8f546d68494cda5357b945ab8d6d4090_37035_1024x0_resize_box_3.png 1024w"
				width="2048"
				height="184"
				loading="lazy"
				>
		</a>
		
	</figure></p>
<p><figure style="flex-grow: 1113; flex-basis: 2671px">
		<a href="/p/shipping-some-hacl/nss-solaris-hacl-bug.png" data-size="2048x184"><img src="/p/shipping-some-hacl/nss-solaris-hacl-bug.png"
				srcset="/p/shipping-some-hacl/nss-solaris-hacl-bug_hu19f69798e7220ccf971107e9a02084f9_34408_480x0_resize_box_3.png 480w, /p/shipping-some-hacl/nss-solaris-hacl-bug_hu19f69798e7220ccf971107e9a02084f9_34408_1024x0_resize_box_3.png 1024w"
				width="2048"
				height="184"
				loading="lazy"
				>
		</a>
		
	</figure></p>
<p>Especially code that is hardware dependent such as Intel intrinsics needs extra attention.
The <a class="link" href="https://github.com/mitls/hacl-star/blob/master/snapshots/kremlib/vec128.h"  target="_blank" rel="noopener"
    ><code>vec128.h</code></a> header used by HACL* to abstract hardware instructions needed a couple iterations before it worked on all supported platforms.</p>
<h2 id="handling-change">Handling change</h2>
<p>The code imported from HACL* into NSS is not expected to change a lot.
But there are always reasons why the code has to get updated and a process is required to do so.
To fix issues like broken platforms, changes to the upstream projects have to be landed and the snapshot in NSS has to get updated to the new upstream version.
For this process to run smoothly it&rsquo;s necessary for both teams to work together.</p>
<p>Updating the HACL* code in NSS is pretty easy.
First the new code is generated with a new version of HACL*, formatted, and copied to NSS.
Then the docker image running the CI gets updated.
Here&rsquo;s a diff for a recent update.</p>
<p><figure style="flex-grow: 231; flex-basis: 554px">
		<a href="/p/shipping-some-hacl/nss-hacl-patch.png" data-size="2922x1264"><img src="/p/shipping-some-hacl/nss-hacl-patch.png"
				srcset="/p/shipping-some-hacl/nss-hacl-patch_hu805ece9199a9cd293d27098f6d0ff899_195247_480x0_resize_box_3.png 480w, /p/shipping-some-hacl/nss-hacl-patch_hu805ece9199a9cd293d27098f6d0ff899_195247_1024x0_resize_box_3.png 1024w"
				width="2922"
				height="1264"
				loading="lazy"
				>
		</a>
		
	</figure></p>
<h2 id="running-the-verification-in-nss">Running the verification in NSS</h2>
<p>To make sure that whatever we use in NSS actually verifies and the generated code isn&rsquo;t changed manually, the NSS CI has to verify the HACL* snapshot it uses on every run.
NSS uses <a class="link" href="https://github.com/taskcluster"  target="_blank" rel="noopener"
    >taskcluster</a> as CI, which allows us to use a <a class="link" href="https://searchfox.org/nss/source/automation/taskcluster/docker-hacl"  target="_blank" rel="noopener"
    >docker image</a> that re-verifies the used HACL* revision on every push.
Checking the code in NSS is then a simple diff.</p>
<h1 id="lessons-learned">Lessons learned</h1>
<p>The first lesson is that it&rsquo;s possible to ship formally verified software.
The code is relatively simple and self-contained, which makes this easier.
But it shows that formal verification tools are good enough to be used in production.</p>
<p>The second lesson we learned is probably the more valuable one.</p>
<blockquote>
<p><em>Talk to each other and work together.</em></p>
</blockquote>
<p>From an engineering standpoint it might be frightening to start looking at formal verification tools and corresponding languages.
But people working with these tools are happy to help out if that means more people are using their tools.
It will need some effort getting used to the tools and languages but it&rsquo;s well worth it.</p>
<p>For people working on formal methods; You might have to learn a little more than you wanted to know about differences between different platforms and compilers and how to ship software.
But that might be worth the effort if it means your proofs are used in production software that&rsquo;s used by millions of people.</p>
<hr>
<p>Looking for more material on this?
There&rsquo;s a high-level <a class="link" href="https://blog.mozilla.org/security/2017/09/13/verified-cryptography-firefox-57/"  target="_blank" rel="noopener"
    >blog post</a> that talks about the formal verification work in NSS happening at Mozilla.
There has also been a talk at RWC 2018 earlier this year on this work (<a class="link" href="https://rwc.iacr.org/2018/Slides/Beurdouche.pdf"  target="_blank" rel="noopener"
    >slides</a>, <a class="link" href="https://www.youtube.com/watch?v=xrZTVRICpSs"  target="_blank" rel="noopener"
    >video</a>).</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/nss/">NSS</a>
        
            <a href="/tags/hacl/">hacl*</a>
        
            <a href="/tags/formal-verification/">formal verification</a>
        
    </section>


    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="/p/the-hacl-approach/">
        
        
            <div class="article-image">
                <img src="/p/the-hacl-approach/hacl-chart.6f092057acd5270c201289c9abd6cc4e_hubf5385a0c6763cff9ba6bbfffd88a9a5_61924_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="" 
                        data-hash="md5-bwkgV6zVJwwgEonJq9bMTg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">The HACL* approach</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2013 - 
        
        2022 Dr Franziskus Kiefer
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.1.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#correctness">Correctness</a></li>
    <li><a href="#performance">Performance</a></li>
    <li><a href="#code-quality">Code quality</a>
      <ol>
        <li><a href="#some-pain-points-remain">Some pain points remain</a></li>
      </ol>
    </li>
    <li><a href="#platform-support">Platform support</a></li>
    <li><a href="#handling-change">Handling change</a></li>
    <li><a href="#running-the-verification-in-nss">Running the verification in NSS</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
