<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="If you didn&rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr\nHACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.\nIn this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms. In short, how to ship (some parts of) HACL*.\n"><title>Shipping (some) HACL*</title>
<link rel=canonical href=https://www.franziskuskiefer.de/p/shipping-some-hacl/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Shipping (some) HACL*"><meta property='og:description' content="If you didn&rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr\nHACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.\nIn this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms. In short, how to ship (some parts of) HACL*.\n"><meta property='og:url' content='https://www.franziskuskiefer.de/p/shipping-some-hacl/'><meta property='og:site_name' content='Dr Franziskus Kiefer'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='nss'><meta property='article:tag' content='HACL*'><meta property='article:tag' content='formal verification'><meta property='article:published_time' content='2018-04-12T00:00:00+00:00'><meta property='article:modified_time' content='2018-04-12T00:00:00+00:00'><meta property='og:image' content='https://www.franziskuskiefer.de/p/shipping-some-hacl/hero.jpg'><meta name=twitter:title content="Shipping (some) HACL*"><meta name=twitter:description content="If you didn&rsquo;t read the article about the HACL* approach, go there first and read it. tl;dr\nHACL* is a cryptographic library written in F* that allows translation to C using kremlin. It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.\nIn this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms. In short, how to ship (some parts of) HACL*.\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.franziskuskiefer.de/p/shipping-some-hacl/hero.jpg'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/profilepic_hu11425891720239459000.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Dr Franziskus Kiefer</a></h1><h2 class=site-description>Cryptography & Security Engineer and Researcher based in Berlin</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/publications/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Publications</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://github.com/franziskuskiefer/ target=_blank><svg class="icon icon-tabler icon-tabler-brand-github" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
<span>Github</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#correctness>Correctness</a></li><li><a href=#performance>Performance</a></li><li><a href=#code-quality>Code quality</a><ol><li><a href=#some-pain-points-remain>Some pain points remain</a></li></ol></li><li><a href=#platform-support>Platform support</a></li><li><a href=#handling-change>Handling change</a></li><li><a href=#running-the-verification-in-nss>Running the verification in NSS</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/shipping-some-hacl/><img src=/p/shipping-some-hacl/hero_hu10352065143677064402.jpg srcset="/p/shipping-some-hacl/hero_hu10352065143677064402.jpg 800w, /p/shipping-some-hacl/hero_hu18051299099010610851.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post Shipping (some) HACL*"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/shipping-some-hacl/>Shipping (some) HACL*</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 12, 2018</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>If you didn&rsquo;t read the article about the <a class=link href=../hacl-star/>HACL* approach</a>, go there first and read it. tl;dr</p><blockquote><p><a class=link href=https://github.com/mitls/hacl-star/ target=_blank rel=noopener>HACL*</a> is a cryptographic library written in <a class=link href=https://www.fstar-lang.org/ target=_blank rel=noopener>F*</a> that allows translation to C using kremlin.
It guarantees memory safety, secret independent computation, and functional correctness with respect to a mathematical specification.</p></blockquote><hr><p>In this second blog post I describe the process of integrating code from HACL*, a researchy crypto library, into NSS, a production library shipping to millions of people, running on a plethora of platforms.
In short, how to ship (some parts of) HACL*.</p><h1 id=shipping-formally-verified-code>Shipping formally verified code</h1><p>Before integrating any code from HACL* into NSS there had to be some criteria the code had to fulfil in order to get considered and a process of integrating, maintaining, and updating the code.
The criteria roughly looked like this:</p><ul><li>The code has to be correct.</li><li>Performance must not be degraded by any new code.</li><li>The code has to be human readable and modifiable, i.e. it must pass a code review process.</li><li>The code must run on all platforms supported by NSS or must have fallback code for platforms that are not supported.</li><li>Upstream changes can to be integrated easily into NSS and fixes can be integrated upstream.</li><li>The verification and generation toolchain has to run in the NSS world.</li></ul><p>We started integrating HACL* crypto primitives into NSS with <a class=link href=https://tools.ietf.org/html/rfc7748 target=_blank rel=noopener>Curve25519</a>.
At the time of writing NSS contains code from HACL* for Curve25519 64-bit, <a class=link href=https://tools.ietf.org/html/rfc7539 target=_blank rel=noopener>Poly1305</a> 32-bit and 64-bit, <a class=link href=https://tools.ietf.org/html/rfc7539 target=_blank rel=noopener>ChaCha20</a>, and ChaCha20 with SSSE3 hardware acceleration.
More primitives are in the pipeline and will be integrated in the near future.</p><h2 id=correctness>Correctness</h2><p>Any code that lands in NSS has to be correct, obviously.
This might be evident but when talking about HACL* generated C code, correctness is not so simple.
Correctness can be checked relatively easily by looking at the HACL* specification of a given primitive.
This code is relatively easy to review (when familiar with F*) as it closely resembles the mathematical specification of the primitive.
The correctness of the C code is guaranteed by the formal proofs from HACL*.
In addition we run all the usual test vectors on it of course.
To catch any errors in the extraction chain from F* to C the extracted C code is reviewed for correctness as well.</p><h2 id=performance>Performance</h2><p>Performance was not a big concern.
As shown in the <a class=link href=https://github.com/mitls/hacl-star/blob/master/doc/papers/hacl-star-ccs2017.pdf target=_blank rel=noopener>HACL* paper from CCS 2017</a>, performance of most primitives is on par with or better than the fastest C implementations out there.
Nonetheless, performance of each primitive is compared between HACL* and the NSS to make sure not to degrade performance.
For every primitive I looked at so far the performance of HACL* was at least as good as the performance of the NSS code.</p><h2 id=code-quality>Code quality</h2><p>Code quality was, as with any generated code, a big concern.
How readable is the generated code? Can it easily be changed if the need arises?
The first versions we looked at weren&rsquo;t that great &mldr;</p><p><img src=/p/shipping-some-hacl/hacl-review.png width=1983 height=747 srcset="/p/shipping-some-hacl/hacl-review_hu4499019627654614460.png 480w, /p/shipping-some-hacl/hacl-review_hu14670101420540871018.png 1024w" loading=lazy class=gallery-image data-flex-grow=265 data-flex-basis=637px>
<img src=/p/shipping-some-hacl/ugly-hacl.png width=755 height=147 srcset="/p/shipping-some-hacl/ugly-hacl_hu6016185786980744563.png 480w, /p/shipping-some-hacl/ugly-hacl_hu14117722760368656323.png 1024w" loading=lazy class=gallery-image data-flex-grow=513 data-flex-basis=1232px></p><p>But after a couple improvements to kremlin the code was good to go.
While every new piece of code that&rsquo;s being integrated has to pass code review the C code produced by kremlin is good enough now to land new primitives without having to improve upstream code first.
Note however that code passes review here that wouldn&rsquo;t pass if it were hand-written.
The code generator is not perfect.
We have to live with some rough edges.
The most important point is that the code is understandable.</p><p>NSS if formatted with <code>clang-format</code>, which is checked on CI.
So the only change to the verified C code imported from HACL* is formatting.</p><h3 id=some-pain-points-remain>Some pain points remain</h3><p>There are some outstanding issues that I hope get fixed in kremlin and would improve code quality significantly.
Kremlin doesn&rsquo;t know <code>const</code>, which is one of the few nice helpers one can use in C to control what&rsquo;s happening to your pointer.
While <code>const</code> is not necessary because of the HACL* proofs, it would be nice to have.
Kremlin further generates unnecessary casts such as <code>(uint32_t)4U</code>.
This is not a big deal but makes code harder to read.
There&rsquo;s also a big number of temporary variables that aren&rsquo;t necessary and make the code harder to read.</p><h2 id=platform-support>Platform support</h2><p>Being a researchy library HACL* is not tested on a big variety of platforms.
NSS on the other hand has to run on most available platforms as well as a number of legacy platforms.
While the NSS CI covers Windows, Linux, and Mac in different configurations such as Intel 32-bit, 64-bit, and aarch64, there are other platforms such as BSD using NSS that are not covered.
As expected we ran into a couple issues on some platforms such as BSD and Solaris but they were quickly resolved.</p><p><img src=/p/shipping-some-hacl/nss-bsd-hacl-bug.png width=2048 height=184 srcset="/p/shipping-some-hacl/nss-bsd-hacl-bug_hu5090590584940457725.png 480w, /p/shipping-some-hacl/nss-bsd-hacl-bug_hu14518716714003580782.png 1024w" loading=lazy class=gallery-image data-flex-grow=1113 data-flex-basis=2671px></p><p><img src=/p/shipping-some-hacl/nss-solaris-hacl-bug.png width=2048 height=184 srcset="/p/shipping-some-hacl/nss-solaris-hacl-bug_hu5722108412057574063.png 480w, /p/shipping-some-hacl/nss-solaris-hacl-bug_hu1645630068384567860.png 1024w" loading=lazy class=gallery-image data-flex-grow=1113 data-flex-basis=2671px></p><p>Especially code that is hardware dependent such as Intel intrinsics needs extra attention.
The <a class=link href=https://github.com/mitls/hacl-star/blob/master/snapshots/kremlib/vec128.h target=_blank rel=noopener><code>vec128.h</code></a> header used by HACL* to abstract hardware instructions needed a couple iterations before it worked on all supported platforms.</p><h2 id=handling-change>Handling change</h2><p>The code imported from HACL* into NSS is not expected to change a lot.
But there are always reasons why the code has to get updated and a process is required to do so.
To fix issues like broken platforms, changes to the upstream projects have to be landed and the snapshot in NSS has to get updated to the new upstream version.
For this process to run smoothly it&rsquo;s necessary for both teams to work together.</p><p>Updating the HACL* code in NSS is pretty easy.
First the new code is generated with a new version of HACL*, formatted, and copied to NSS.
Then the docker image running the CI gets updated.
Here&rsquo;s a diff for a recent update.</p><p><img src=/p/shipping-some-hacl/nss-hacl-patch.png width=2922 height=1264 srcset="/p/shipping-some-hacl/nss-hacl-patch_hu12663953578200761238.png 480w, /p/shipping-some-hacl/nss-hacl-patch_hu5796332706377407724.png 1024w" loading=lazy class=gallery-image data-flex-grow=231 data-flex-basis=554px></p><h2 id=running-the-verification-in-nss>Running the verification in NSS</h2><p>To make sure that whatever we use in NSS actually verifies and the generated code isn&rsquo;t changed manually, the NSS CI has to verify the HACL* snapshot it uses on every run.
NSS uses <a class=link href=https://github.com/taskcluster target=_blank rel=noopener>taskcluster</a> as CI, which allows us to use a <a class=link href=https://searchfox.org/nss/source/automation/taskcluster/docker-hacl target=_blank rel=noopener>docker image</a> that re-verifies the used HACL* revision on every push.
Checking the code in NSS is then a simple diff.</p><h1 id=lessons-learned>Lessons learned</h1><p>The first lesson is that it&rsquo;s possible to ship formally verified software.
The code is relatively simple and self-contained, which makes this easier.
But it shows that formal verification tools are good enough to be used in production.</p><p>The second lesson we learned is probably the more valuable one.</p><blockquote><p><em>Talk to each other and work together.</em></p></blockquote><p>From an engineering standpoint it might be frightening to start looking at formal verification tools and corresponding languages.
But people working with these tools are happy to help out if that means more people are using their tools.
It will need some effort getting used to the tools and languages but it&rsquo;s well worth it.</p><p>For people working on formal methods; You might have to learn a little more than you wanted to know about differences between different platforms and compilers and how to ship software.
But that might be worth the effort if it means your proofs are used in production software that&rsquo;s used by millions of people.</p><hr><p>Looking for more material on this?
There&rsquo;s a high-level <a class=link href=https://blog.mozilla.org/security/2017/09/13/verified-cryptography-firefox-57/ target=_blank rel=noopener>blog post</a> that talks about the formal verification work in NSS happening at Mozilla.
There has also been a talk at RWC 2018 earlier this year on this work (<a class=link href=https://rwc.iacr.org/2018/Slides/Beurdouche.pdf target=_blank rel=noopener>slides</a>, <a class=link href="https://www.youtube.com/watch?v=xrZTVRICpSs" target=_blank rel=noopener>video</a>).</p></section><footer class=article-footer><section class=article-tags><a href=/tags/nss/>NSS</a>
<a href=/tags/hacl/>HACL*</a>
<a href=/tags/formal-verification/>Formal Verification</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/the-hacl-approach/><div class=article-image><img src=/p/the-hacl-approach/hacl-chart.6f092057acd5270c201289c9abd6cc4e_hu9798257387999726609.png width=250 height=150 loading=lazy alt="Featured image of post The HACL* approach" data-hash="md5-bwkgV6zVJwwgEonJq9bMTg=="></div><div class=article-details><h2 class=article-title>The HACL* approach</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2013 -
2024 Dr Franziskus Kiefer</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>