<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
     
    <title>Franziskus Kiefer  | CVE-2017-5462 - A PRNG issue</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
     <meta name="generator" content="Hugo 0.59.1" />
      
      
        <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
      

     <link href='https://www.franziskuskiefer.de/dist/main.css' rel='stylesheet' type="text/css" />

     

      <meta property="og:title" content="CVE-2017-5462 - A PRNG issue" />
<meta property="og:description" content="On April 19, 2017, Mozilla Foundation published the Security Advisory 2017-10 outlining several recently fixed security vulnerabilities. One of these vulnerabilities, tracked as CVE-2017-5462, affects the Pseudo-Random Number Generator (PRNG) within the Network Security Services (NSS) library prior to version 3.29.5 and Firefox prior to version 53.
This post describes the bug and how it was discovered.
Inside the NSS PRNG NSS uses Hash_DRBG as PRNG, which is one of several PRNG schemes defined in the NIST Special Publication 800-90." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.franziskuskiefer.de/post/cve-2017-5462/" />
<meta property="article:published_time" content="2017-08-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-08-31T00:00:00+00:00" />
<meta itemprop="name" content="CVE-2017-5462 - A PRNG issue">
<meta itemprop="description" content="On April 19, 2017, Mozilla Foundation published the Security Advisory 2017-10 outlining several recently fixed security vulnerabilities. One of these vulnerabilities, tracked as CVE-2017-5462, affects the Pseudo-Random Number Generator (PRNG) within the Network Security Services (NSS) library prior to version 3.29.5 and Firefox prior to version 53.
This post describes the bug and how it was discovered.
Inside the NSS PRNG NSS uses Hash_DRBG as PRNG, which is one of several PRNG schemes defined in the NIST Special Publication 800-90.">


<meta itemprop="datePublished" content="2017-08-31T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-08-31T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1109">



<meta itemprop="keywords" content="prng,NSS," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2017-5462 - A PRNG issue"/>
<meta name="twitter:description" content="On April 19, 2017, Mozilla Foundation published the Security Advisory 2017-10 outlining several recently fixed security vulnerabilities. One of these vulnerabilities, tracked as CVE-2017-5462, affects the Pseudo-Random Number Generator (PRNG) within the Network Security Services (NSS) library prior to version 3.29.5 and Firefox prior to version 53.
This post describes the bug and how it was discovered.
Inside the NSS PRNG NSS uses Hash_DRBG as PRNG, which is one of several PRNG schemes defined in the NIST Special Publication 800-90."/>

        
      
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://www.franziskuskiefer.de/" class="f3 fw2 hover-white no-underline white-90 dib">
      Franziskus Kiefer
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Articles page">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/publications/" title="Publications page">
              Publications
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/resume/" title="Résumé page">
              Résumé
            </a>
          </li>
          
        </ul>
      
      



  <a href="https://twitter.com/_franziskus_" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>




    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <div class="flex-l mt2 mw8 center">
    <article class="center cf pv5 ph3 ph4-ns mw7">
      <p class="f6 b helvetica tracked">
        
        POST
      </p>
      <h1 class="f1 athelas">
        CVE-2017-5462 - A PRNG issue
      </h1>
        
        
      <time class="f6 mv4 dib tracked" datetime="2017-08-31T00:00:00Z">
        August 31, 2017
      </time>
      <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray">
        

<p>On April 19, 2017, Mozilla Foundation published the <a href="https://www.mozilla.org/en-US/security/advisories/mfsa2017-10/#CVE-2017-5462">Security Advisory 2017-10</a> outlining several recently fixed security vulnerabilities.
One of these vulnerabilities, tracked as CVE-2017-5462, affects the Pseudo-Random Number Generator (PRNG) within the Network Security Services (NSS) library prior to version 3.29.5 and Firefox prior to version 53.</p>

<p>This post describes the bug and how it was discovered.</p>

<h1 id="inside-the-nss-prng">Inside the NSS PRNG</h1>

<p>NSS uses <code>Hash_DRBG</code> as PRNG, which is one of several PRNG schemes defined in the <a href="http://csrc.nist.gov/publications/nistpubs/">NIST Special Publication 800-90</a>.
Like most widely used PRNGs the <code>Hash_DRBG</code> is a Deterministic Random Bit Generator (DRBG). (Even though this term is usually only used for NIST PRNGs.)
While the standard contains all the details, the relevant features can be summarised as follows.</p>

<p>The state of <code>Hash_DRBG</code> is composed of three values:</p>

<ul>
<li>A 55-byte integer state variable <code>V</code>, which is updated with each
request of new bits</li>
<li>A 55-byte integer constant <code>C</code> that depends on the seed and is updated when re-seeding the PRNG.</li>
<li>A counter <code>c</code> tracking when the next re-seeding is needed.</li>
</ul>

<p>To generate random bits, <code>Hash_DRBG</code> concatenates <code>H(V) || H(V+1) || H(V+2) || ...</code> until enough bits are generated.
<code>H</code> denotes a cryptographic hash function here.
NSS uses the SHA-256 hash function for <code>H</code> with a digest length of 32 bytes.
After generating new bits the state variable <code>V</code> is updated according to the rule <code>V</code><sub><code>c+1</code></sub> <code>= V + H(0x03 || V</code><sub><code>c</code></sub> <code>) + C + c</code> and counter <code>c</code> is incremented by one.
Addition is performed modulo <code>2</code><sup><code>440</code></sup> <code>= 2</code><sup><code>8*55</code></sup> to fit it in the 55 bytes of <code>V</code>.</p>

<p>The PRNG implementation can be found in the file <a href="https://searchfox.org/nss/rev/fcdcad1fc1ddb6e70653637b0ea0f3359b8533f2/lib/freebl/drbg.c">drbg.c</a> within the NSS codebase.</p>

<h1 id="cve-2017-5462">CVE-2017-5462</h1>

<p>The issue identified in CVE-2017-5462 is in the code implementing the addition.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * build some fast inline functions for adding.
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">#define PRNG_ADD_CARRY_ONLY(dest, start, carry)    \
</span><span style="color:#75715e">    {                                              \
</span><span style="color:#75715e">        int k1;                                    \
</span><span style="color:#75715e">        for (k1 = start; carry &amp;&amp; k1 &gt;= 0; k1--) { \
</span><span style="color:#75715e">            carry = !(++dest[k1]);                 \
</span><span style="color:#75715e">        }                                          \
</span><span style="color:#75715e">    }
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*
</span><span style="color:#75715e"> * NOTE: dest must be an array for the following to work.
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">#define PRNG_ADD_BITS(dest, dest_len, add, len, carry)               \
</span><span style="color:#75715e">    carry = 0;                                                       \
</span><span style="color:#75715e">    PORT_Assert((dest_len) &gt;= (len));                                \
</span><span style="color:#75715e">    {                                                                \
</span><span style="color:#75715e">        int k1, k2;                                                  \
</span><span style="color:#75715e">        for (k1 = dest_len - 1, k2 = len - 1; k2 &gt;= 0; --k1, --k2) { \
</span><span style="color:#75715e">            carry += dest[k1] + add[k2];                             \
</span><span style="color:#75715e">            dest[k1] = (PRUint8)carry;                               \
</span><span style="color:#75715e">            carry &gt;&gt;= 8;                                             \
</span><span style="color:#75715e">        }                                                            \
</span><span style="color:#75715e">    }
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define PRNG_ADD_BITS_AND_CARRY(dest, dest_len, add, len, carry) \
</span><span style="color:#75715e">    PRNG_ADD_BITS(dest, dest_len, add, len, carry)               \
</span><span style="color:#75715e">    PRNG_ADD_CARRY_ONLY(dest, dest_len - len, carry)</span></code></pre></div>
<p>When the PRNG performs addition to update <code>V</code> it uses the macro <code>PRNG_ADD_BITS_AND_CARRY</code>, which first delegates to the macro <code>PRNG_ADD_BITS</code> to add the two summands without considering the final carry and then the macro <code>PRNG_ADD_CARRY_ONLY</code> to add the carry.</p>

<p>In this addition code it is clear that the carry should be added at the position <em>preceding</em> the original most-significant-byte of the shorter of the two summands.
This fact was supposed to be represented by the index <code>dest_len-len</code> supplied as parameter to <code>PRNG_ADD_CARRY_ONLY</code>.
Note that numbers are represented as sequences of bytes with byte number zero being the most-significant byte.
The essence of the bug is that <code>dest_len-len</code> does not point to the correct position of the carry, which should have been added at position <code>dest_len-len-1</code> instead.</p>

<figure><a href="../../images/CVE-2017-5462-bug.png">
    <img src="../../images/CVE-2017-5462-bug.png"/> </a>
</figure>


<h2 id="example">Example</h2>

<p>We note that <code>3 * 0x40 = 0xc0</code> under both proper and broken addition (the latter due to absence of carrying in this example).
However, <code>3 * 0x95 = 0x01bf</code> under proper unbounded addition resp. <code>0xbf</code> under proper modulo addition.
Yet, the result under broken addition is <code>0x01 + 0xbf = 0xc0</code>.</p>

<h1 id="finding-the-bug-with-testing">Finding the Bug with Testing</h1>

<p>The easiest way to find most types of bugs in PRNGs following NIST SP 800-90 is by testing the implementation with the official test vectors (seeds and outputs) provided in the standard.
I found the bug after implementing these test vectors.
Functional unit testing would probably have caught this particular bug as well.
For PRNGs not following the NIST standard, defining corresponding test vectors is a good idea to avoid regressions during maintenance.</p>

<p>Statistical tests such as NIST SP 800-22 or <a href="https://github.com/ticki/diehardest">DIEHARDEST</a> are not very useful for testing cryptographic PRNGs.
They can be used for testing the entropy pool that is fed into the PRNG.
But such tests will not fail as long as the internal state does not stay constant and output passes through a cryptographic primitive (such as SHA-256) before reaching the consumer.</p>

<h1 id="formal-analysis">Formal Analysis</h1>

<p>Independ of my investigation, <a href="https://formal.iti.kit.edu/klebanov/">Vladimir Klebanov</a> found this bug using <a href="https://formal.iti.kit.edu/~klebanov/software/entroposcope/">Entroposcope</a>, a static analysis tool created for finding implementation bugs in pseudo-random number generators.</p>

<p>Entropy loss occurs when the number of possible output streams is less than the number of possible seeds.
This is equivalent to the case when two different seeds produce the same output stream (also called a collision).
Entroposcope is built on top of the bounded model checker <a href="https://link.springer.com/chapter/10.1007/978-3-642-54862-8_26">CBMC</a>, which in turn transforms the problem into a challenge for a <a href="https://en.wikipedia.org/wiki/Boolean_satisfiability_problem">SAT solver</a>.</p>

<p>Considering the <code>Hash_DRBG</code>, the question whether <code>V</code><sub><code>c+1</code></sub> <code>= V + H(0x03 || V</code><sub><code>c</code></sub> <code>) + C + c</code> produces a collision and the DRBG loses entropy or not boils down to whether distinct 55-byte values <code>x</code><sub><code>1</code></sub>, <code>x</code><sub><code>2</code></sub> exist, such that <code>x</code><sub><code>1</code></sub> <code>+ H(x</code><sub><code>1</code></sub><code>) = x</code><sub><code>2</code></sub> <code>+ H(x</code><sub><code>2</code></sub><code>)</code>.
Now, it is clear that this question cannot be answered without either knowing the output of <code>H</code> for each 55-byte input (which is infeasible) or some (unknown to us and certainly also to the tool) nontrivial mathematical argument on the nature of <code>H</code> in this context.
In this regard, the <code>Hash_DRBG</code> differs from many other PRNGs that employ significantly simpler operations on the output of <code>H</code> before it makes its way to the PRNG caller.</p>

<p>As a consequence of this design, Entroposcope can not be used to prove absence of entropy loss in the <code>Hash_DRBG</code>.
Nonetheless, Entroposcope can check collision-freedom of the PRNG under an idealised <code>H</code> and find bugs in the parts of the implementation that are not <code>H</code>.
For this purpose we consider an idealised PRNG with <code>H(b||V) = V</code> and <code>C = V</code><sub><code>0</code></sub>.
This is the same kind of idealisation that helped Vladimir to uncover previously unknown bugs in OpenSSL and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6313">GnuPG</a>.
With the idealisation, on the first iteration (<code>c = 0</code>) updating the state becomes <code>V</code><sub><code>1</code></sub> <code>= 3 * V</code><sub><code>0</code></sub>.
Because <code>3</code> and <code>2</code><sup><code>440</code></sup> are co-prime, <code>V</code><sub><code>1</code></sub> will not produce a collision if implemented properly.</p>

<p>Indeed, given the idealised code, Entroposcope produced a counterexample to entropy preservation with two concrete seeds leading to the same output stream.
Tracing these two executions makes it easy to pinpoint the cause of the collision in the addition code.</p>

<p>Thanks to Vladimir for finding this bug and helping to write this post.</p>

      </section>
      

  
  
  
  
  


    </article>
  </div>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://www.franziskuskiefer.de/" >
    &copy; 2019 Franziskus Kiefer
  </a>
  



  <a href="https://twitter.com/_franziskus_" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>




  </div>
</footer>

    <script src="https://www.franziskuskiefer.de/dist/app.bundle.js" async></script>

  </body>
</html>
