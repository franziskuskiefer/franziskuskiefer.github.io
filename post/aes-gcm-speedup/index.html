<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
     
    <title>Franziskus Kiefer  | Aes Gcm Speedup</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
     <meta name="generator" content="Hugo 0.59.1" />
      
      
        <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
      

     <link href='https://www.franziskuskiefer.de/dist/main.css' rel='stylesheet' type="text/css" />

     

      <meta property="og:title" content="Aes Gcm Speedup" />
<meta property="og:description" content="AES-GCM is a NIST standardised authenticated encryption algorithm (FIPS 800-38D). Since its standardisation in 2008 its usage increased to a point where it is the prevalent encryption used with TLS. With 85% it is by far the most widely used cipher.
 Firefox 53 TLS cipher telemetry   Unfortunately the AES-GCM implementation used in Firefox (provided by NSS) does not take advantage of full hardware acceleration; it uses a slower software-only implementation on Mac, Linux 32-bit, or any device that doesn&rsquo;t have the AVX, PCLMUL, and AES-NI hardware instructions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.franziskuskiefer.de/post/aes-gcm-speedup/" />
<meta property="article:published_time" content="2017-06-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-06-27T00:00:00+00:00" />
<meta itemprop="name" content="Aes Gcm Speedup">
<meta itemprop="description" content="AES-GCM is a NIST standardised authenticated encryption algorithm (FIPS 800-38D). Since its standardisation in 2008 its usage increased to a point where it is the prevalent encryption used with TLS. With 85% it is by far the most widely used cipher.
 Firefox 53 TLS cipher telemetry   Unfortunately the AES-GCM implementation used in Firefox (provided by NSS) does not take advantage of full hardware acceleration; it uses a slower software-only implementation on Mac, Linux 32-bit, or any device that doesn&rsquo;t have the AVX, PCLMUL, and AES-NI hardware instructions.">


<meta itemprop="datePublished" content="2017-06-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-06-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1067">



<meta itemprop="keywords" content="speed,NSS," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Aes Gcm Speedup"/>
<meta name="twitter:description" content="AES-GCM is a NIST standardised authenticated encryption algorithm (FIPS 800-38D). Since its standardisation in 2008 its usage increased to a point where it is the prevalent encryption used with TLS. With 85% it is by far the most widely used cipher.
 Firefox 53 TLS cipher telemetry   Unfortunately the AES-GCM implementation used in Firefox (provided by NSS) does not take advantage of full hardware acceleration; it uses a slower software-only implementation on Mac, Linux 32-bit, or any device that doesn&rsquo;t have the AVX, PCLMUL, and AES-NI hardware instructions."/>

        
      
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  <header class="cover bg-top" style="background-image: url('https://www.franziskuskiefer.de/images/linux64-encrypt.png');">
    <div class="pb3-m pb6-l bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://www.franziskuskiefer.de/" class="f3 fw2 hover-white no-underline white-90 dib">
      Franziskus Kiefer
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Articles page">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/publications/" title="Publications page">
              Publications
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/resume/" title="Résumé page">
              Résumé
            </a>
          </li>
          
        </ul>
      
      



  <a href="https://twitter.com/_franziskus_" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>




    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        <h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Aes Gcm Speedup</h1>
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  <div class="flex-l mt2 mw8 center">
    <article class="center cf pv5 ph3 ph4-ns mw7">
      <p class="f6 b helvetica tracked">
        
        POST
      </p>
      <h1 class="f1 athelas">
        Aes Gcm Speedup
      </h1>
        
        
      <time class="f6 mv4 dib tracked" datetime="2017-06-27T00:00:00Z">
        June 27, 2017
      </time>
      <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray">
        

<p>AES-GCM is a NIST standardised authenticated encryption algorithm (FIPS 800-38D). Since its standardisation in 2008 its usage increased to a point where it is the prevalent encryption used with TLS. With 85% it is by far the <a href="https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&amp;end_date=2017-05-24&amp;keys=__none__!__none__!__none__&amp;max_channel_version=release%252F53&amp;measure=SSL_SYMMETRIC_CIPHER_FULL&amp;min_channel_version=null&amp;processType=*&amp;product=Firefox&amp;sanitize=1&amp;sort_keys=submissions&amp;start_date=2017-04-13&amp;table=0&amp;trim=1&amp;use_submission_date=0">most widely used cipher</a>.</p>

<figure><a href="../../images/Screenshot-from-2017-06-14-10-09-27.png">
    <img src="../../images/Screenshot-from-2017-06-14-10-09-27.png"/> </a><figcaption>
            <h4>Firefox 53 TLS cipher telemetry</h4>
        </figcaption>
</figure>


<p>Unfortunately the AES-GCM implementation used in Firefox (provided by NSS) does not take advantage of full hardware acceleration; it uses a slower software-only implementation on Mac, Linux 32-bit, or any device that doesn&rsquo;t have the <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">AVX</a>, <a href="https://en.wikipedia.org/wiki/CLMUL_instruction_set">PCLMUL</a>, and <a href="https://en.wikipedia.org/wiki/AES_instruction_set">AES-NI</a> hardware instructions. Looking at these numbers about only 30% of Firefox users get full hardware acceleration.</p>

<p>Before jumping on the obvious issue of Firefox’s AES-GCM code being comparatively slow – as well as not being resistant to <a href="https://en.wikipedia.org/wiki/Side-channel_attack">side channel analysis</a> –  I wanted to see what the actual impact on Firefox users is. Downloading a file on a mid-2015 MacBook Pro Retina with Firefox incurs CPU usage of 50% with 17% of Firefox&rsquo;s CPU usage is in <code>ssl3_AESGCM</code>. In comparison, Chrome only creates 15% CPU usage with the same download. On a Windows laptop with an AMD C-70 (no AES-NI) Firefox CPU usage is 60% and the download speed is capped at 3.5MB/s. Chrome on the same machine needs 50% of the CPU and downloads with 10MB/s. This doesn&rsquo;t seem to be only an academic issue: Particularly for battery-operated devices, the energy consumption difference would be noticeable.</p>

<h1 id="improving-gcm-performance">Improving GCM performance</h1>

<p>Speeding up the GCM multiplication function is the first obvious step to improve AES-GCM performance. A <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=868948">bug</a> was opened on integration of the original AES-GCM code to provide an alternative to the textbook implementation of <code>gcm_HashMult</code>. This code is not only slow but has timing side channels. Here an excerpt from the <a href="https://searchfox.org/mozilla-central/rev/d67ef71097da4d1aa344c9d9c672e49a7228e765/security/nss/lib/freebl/mpi/mp_gf2m.c#337">binary multiplication</a> algorithm.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">for</span> (ib <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; ib <span style="color:#f92672">&lt;</span> b_used; ib<span style="color:#f92672">++</span>) {
    b_i <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pb<span style="color:#f92672">++</span>;

    <span style="color:#75715e">/* Inner product:  Digits of a */</span>
    <span style="color:#66d9ef">if</span> (b_i)
       s_bmul_d_add(MP_DIGITS(a), a_used, b_i, MP_DIGITS(c) <span style="color:#f92672">+</span> ib);
    <span style="color:#66d9ef">else</span>
        <span style="color:#a6e22e">MP_DIGIT</span>(c, ib <span style="color:#f92672">+</span> a_used) <span style="color:#f92672">=</span> b_i;
}
</code></pre></div>
<p>We can improve on two fronts here. First NSS should use PCLMUL to speed up the ghash multiplication if possible. Second if PCLMUL is not available, NSS should use a fast constant-time implementation.</p>

<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=868948">Bug 868948</a> has several attempts of speeding up the software implementation without introducing timing side-channels. Unfortunately the fastest code that was proposed uses table lookups and is therefore not constant-time. Thanks to <a href="https://www.bearssl.org/constanttime.html">Thomas Pornin</a> I found a nicer way to implement the binary multiplication in a way that doesn&rsquo;t leak any timing information and is still faster than any other code I&rsquo;ve seen. (Check out Thomas&rsquo; excellent write-up for details.)</p>

<p>If PCLMUL is available on the CPU, using it is of course the way to go. All modern compilers support intrinsics, which allows us to write &ldquo;inline assembly&rdquo; in C that runs on all platforms without having to write assembly. A hardware accelerated implementation of the ghash multiplication can be <a href="https://searchfox.org/nss/rev/40ab32e6acb227e7ede4734573e448ff43d179d5/lib/freebl/gcm.c#314">easily implemented</a> with <a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#text=clmul&amp;expand=641"><code>_mm_clmulepi64_si128</code></a>.</p>

<p>On Mac and Linux the new 32-bit and 64-bit software ghash functions (faster and constant-time) are used on the respective platforms if PCLMUL or AVX is not available. Since Windows doesn&rsquo;t support 128-bit integers (outside of registers) NSS falls back to the slower 32-bit ghash code (which is still more than 25% faster).</p>

<h1 id="improving-aes-performance">Improving AES performance</h1>

<p>To speed up AES NSS requires hardware acceleration on Mac as well as on Linux 32-bit and any machine that doesn&rsquo;t support AVX (or has it disabled). When NSS can&rsquo;t use the specialised AES code it falls back to a table-based implementation that is again not constant-time (in addition to being slow). Implementing AES with <a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#text=aes&amp;expand=641">intrinsics</a> is a breeze.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">    m <span style="color:#f92672">=</span> _mm_xor_si128(m, cx<span style="color:#f92672">-&gt;</span>keySchedule[<span style="color:#ae81ff">0</span>]);
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> cx<span style="color:#f92672">-&gt;</span>Nr; <span style="color:#f92672">++</span>i) {
        m <span style="color:#f92672">=</span> _mm_aesenc_si128(m, cx<span style="color:#f92672">-&gt;</span>keySchedule[i]);
    }
    m <span style="color:#f92672">=</span> _mm_aesenclast_si128(m, cx<span style="color:#f92672">-&gt;</span>keySchedule[cx<span style="color:#f92672">-&gt;</span>Nr]);
    _mm_storeu_si128((<span style="color:#66d9ef">__m128i</span> <span style="color:#f92672">*</span>)output, m);
</code></pre></div>
<p>Key expansion is a little bit more involved (for 192 and 256 bit). But is <a href="https://searchfox.org/nss/rev/40ab32e6acb227e7ede4734573e448ff43d179d5/lib/freebl/rijndael.c#393">written</a> in about 100 lines as well.</p>

<p>Mac sees the biggest improvement here. Previously, only Windows and 64-bit Linux used AES-NI, and now all desktop x86 and x64 platforms use it when available.</p>

<h1 id="looking-at-the-numbers">Looking at the numbers</h1>

<p>To measure the performance gain of the new AES-GCM code I encrypt a 479MB file with a 128-bit key (the most widely used key size for AES-GCM). Note that these numbers are supposed to show a trend and heavily depend on the used machine and system load at the time.</p>

<p>Linux measurements are done on an Intel Core i7-4790, Windows measurements on a Surface Pro 2 with an Intel Core i5-4300U, and Mac (Core i7-4980HQ).</p>

<p><figure><a href="../../images/linux64-encrypt.png">
    <img src="../../images/linux64-encrypt.png"/> </a><figcaption>
            <h4>Linux 64-bit encrypt</h4>
        </figcaption>
</figure>

<figure><a href="../../images/linux32-encrypt.png">
    <img src="../../images/linux32-encrypt.png"/> </a><figcaption>
            <h4>Linux 64-bit encrypt</h4>
        </figcaption>
</figure>
</p>

<p>On 64-bit Linux performance of any machine without AES, PCLMUL, or AVX instructions AES-GCM 128 is at least twice as fast now. If AES and PCLMUL is available, the new code only needs 33% of the time the old code took.
The speed-up for 32-bit Linux is obviously more significant as it didn&rsquo;t have any hardware accelerated code before. With full hardware acceleration the new code is more than 5 times faster than before. In the worst case, when PCLMUL is not available, the speed-up is still more than 50%.</p>

<p>The story is similar on Windows (though NSS had fast code for 32-bit there before).
<figure><a href="../../images/win64-encrypt.png">
    <img src="../../images/win64-encrypt.png"/> </a><figcaption>
            <h4>Windows 64-bit encrypt</h4>
        </figcaption>
</figure>

<figure><a href="../../images/win32-encrypt.png">
    <img src="../../images/win32-encrypt.png"/> </a><figcaption>
            <h4>Windows 32-bit encrypt</h4>
        </figcaption>
</figure>
</p>

<p>Performance improvements on Mac (64-bit only) range from 60% in the best case to 44% when AES-NI or PCLMUL is not available.
<figure><a href="../../images/mac-encrypt.png">
    <img src="../../images/mac-encrypt.png"/> </a><figcaption>
            <h4>OS-X encrypt</h4>
        </figcaption>
</figure>
</p>

<h1 id="the-numbers-in-firefox">The numbers in Firefox</h1>

<p>NSS 3.32 (Firefox 56) will ship with the new AES-GCM code. It will provide significantly reduced CPU usage for most TLS connections or higher download rates. NSS 3.32 is more intelligent in detecting the CPU&rsquo;s capabilities and using hardware acceleration whenever possible. Assuming that all intrinsics and mathematical operations (other than division) are constant-time on the CPU, the new code doesn&rsquo;t have any timing side-channels.</p>

<p>On the basic laptop with the AMD C-70 download rates increased from ~3MB/s to ~6MB/s. (Keep in mind that this is the software only 32-bit implementation.)</p>

<p>The most immediate effect can be seen on Mac. <code>AES_Decrypt</code> as part of a TLS connection with <a href="http://bit.ly/2rGm8S0">NSS 3.31 used 9% CPU</a> while in <a href="http://bit.ly/2rGvGfz">NSS 3.32 it uses only 4%</a>.
To see general performance improvements we can look at the case where AVX is not available (which is the case for about <sup>2</sup>&frasl;<sub>3</sub> of the Firefox population). Assuming that at least AES-NI and PCLMUL is supported by the CPU we see the CPU usage drop from <a href="https://perfht.ml/2rrqbWS">15%</a> to <a href="https://perfht.ml/2sa3aoA">3%</a> (measured on Linux).</p>

      </section>
      

  
  
  
  
  


    </article>
  </div>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://www.franziskuskiefer.de/" >
    &copy; 2019 Franziskus Kiefer
  </a>
  



  <a href="https://twitter.com/_franziskus_" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>




  </div>
</footer>

    <script src="https://www.franziskuskiefer.de/dist/app.bundle.js" async></script>

  </body>
</html>
